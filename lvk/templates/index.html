<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Class Development</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
        }
        .suggestion-text {
            color: #9ca3af;
            font-style: italic;
        }
        .animate-pulse-fast {
            animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .parameter-table {
            display: grid;
            grid-template-columns: 175px 1fr;
            gap: 12px;
            align-items: center;
        }
        .parameter-label {
            text-align: right;
            padding-right: 12px;
        }
        .tab-button.active {
            background-color: #e5e7eb;
            border-bottom: 2px solid #3b82f6;
            color: #1f2937;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .correction-table th, .correction-table td {
            padding: 8px;
            border: 1px solid #d1d5db;
        }
        .correction-table th {
            background-color: #f3f4f6;
            text-align: left;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto p-8 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Liquid Class Development</h1>

        <div class="mb-6">
            <label for="liquid-class-search" class="block text-center text-sm font-medium text-gray-700 mb-2">Search Existing Liquid Classes</label>
            <div class="relative flex justify-center">
                <input type="text" id="liquid-class-search" placeholder="e.g., Water Free, 500ul" class="block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                <div id="search-results" class="absolute z-10 w-1/2 mt-10 bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto"></div>
            </div>
        </div>

        <div class="mb-8 flex justify-center flex-col items-center">
            <label for="new-liquid-class-name" class="block text-sm font-medium text-gray-700 mb-2">New Liquid Class Name</label>
            <input type="text" id="new-liquid-class-name" name="new-liquid-class-name" placeholder="Enter a name for your new class" class="block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
        </div>

        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out active" data-tab="liquid-class-tab">Liquid Class & Tip</button>
            <button class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out" data-tab="correction-curve-tab">Correction Curve</button>
            <button class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out" data-tab="test-actions-tab">Test Actions</button>
        </div>

        <div id="liquid-class-tab" class="tab-content active">
            <form id="liquid-class-form" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Aspirate Parameters</h2>
                    <div class="parameter-table">
                        <label for="AsFlowRate" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Flow Rate (uL/s)</label>
                        <input type="number" id="AsFlowRate" name="AsFlowRate" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsMixFlowRate" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Mix Flow Rate (uL/s)</label>
                        <input type="number" id="AsMixFlowRate" name="AsMixFlowRate" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsAirTransportVolume" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Air Transport Volume (uL)</label>
                        <input type="number" id="AsAirTransportVolume" name="AsAirTransportVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsBlowOutVolume" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Blow Out Volume (uL)</label>
                        <input type="number" id="AsBlowOutVolume" name="AsBlowOutVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsSwapSpeed" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Swap Speed (mm/s)</label>
                        <input type="number" id="AsSwapSpeed" name="AsSwapSpeed" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsSettlingTime" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Settling Time (ms)</label>
                        <input type="number" id="AsSettlingTime" name="AsSettlingTime" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsOverAspirateVolume" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Overaspirate Volume (uL)</label>
                        <input type="number" id="AsOverAspirateVolume" name="AsOverAspirateVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="AsClotRetractHeight" class="parameter-label block text-sm font-medium text-gray-700">Aspirate Clot Retract Height (mm)</label>
                        <input type="number" id="AsClotRetractHeight" name="AsClotRetractHeight" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Dispense & Tip Parameters</h2>
                    <div class="parameter-table">
                        <label for="DsFlowRate" class="parameter-label block text-sm font-medium text-gray-700">Dispense Flow Rate (uL/s)</label>
                        <input type="number" id="DsFlowRate" name="DsFlowRate" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsMixFlowRate" class="parameter-label block text-sm font-medium text-gray-700">Dispense Mix Flow Rate (uL/s)</label>
                        <input type="number" id="DsMixFlowRate" name="DsMixFlowRate" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsAirTransportVolume" class="parameter-label block text-sm font-medium text-gray-700">Dispense Air Transport Volume (uL)</label>
                        <input type="number" id="DsAirTransportVolume" name="DsAirTransportVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsBlowOutVolume" class="parameter-label block text-sm font-medium text-gray-700">Dispense Blow Out Volume (uL)</label>
                        <input type="number" id="DsBlowOutVolume" name="DsBlowOutVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsSwapSpeed" class="parameter-label block text-sm font-medium text-gray-700">Dispense Swap Speed (mm/s)</label>
                        <input type="number" id="DsSwapSpeed" name="DsSwapSpeed" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsSettlingTime" class="parameter-label block text-sm font-medium text-gray-700">Dispense Settling Time (ms)</label>
                        <input type="number" id="DsSettlingTime" name="DsSettlingTime" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsStopFlowRate" class="parameter-label block text-sm font-medium text-gray-700">Dispense Stop Flow Rate (uL/s)</label>
                        <input type="number" id="DsStopFlowRate" name="DsStopFlowRate" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DsStopBackVolume" class="parameter-label block text-sm font-medium text-gray-700">Dispense Stop Back Volume (uL)</label>
                        <input type="number" id="DsStopBackVolume" name="DsStopBackVolume" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border">
                        
                        <label for="DispenseMode" class="parameter-label block text-sm font-medium text-gray-700">Dispense Mode (Mode #)</label>
                        <select id="DispenseMode" name="DispenseMode" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border bg-white">
                            <option value="" disabled selected>Select a mode...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>

                        <label for="TipType" class="parameter-label block text-sm font-medium text-gray-700">Tip Type</label>
                        <select id="TipType" name="TipType" class="input-field block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 border bg-white">
                            <option value="" disabled selected>Select tip type...</option>
                            <option value='{"volume": 10, "has_filter": false}'>10 µL</option>
                            <option value='{"volume": 10, "has_filter": true}'>10 µL Filtered</option>
                            <option value='{"volume": 50, "has_filter": false}'>50 µL</option>
                            <option value='{"volume": 50, "has_filter": true}'>50 µL Filtered</option>
                            <option value='{"volume": 300, "has_filter": false}'>300 µL</option>
                            <option value='{"volume": 300, "has_filter": true}'>300 µL Filtered</option>
                            <option value='{"volume": 1000, "has_filter": false}'>1000 µL</option>
                            <option value='{"volume": 1000, "has_filter": true}'>1000 µL Filtered</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <div id="correction-curve-tab" class="tab-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Correction Curve</h2>
            <div class="flex justify-center mb-4">
                <button id="add-row-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Row</button>
            </div>
            <div class="overflow-x-auto">
                <table id="correction-table" class="min-w-full bg-white rounded-lg shadow-md correction-table">
                    <thead>
                        <tr>
                            <th class="py-2 px-4">Nominal Value (uL)</th>
                            <th class="py-2 px-4">Corrected Value (uL)</th>
                            <th class="py-2 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="test-actions-tab" class="tab-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Test Liquid Class Actions</h2>
            <div class="space-y-4 max-w-md mx-auto">
                <div class="flex flex-col space-y-2">
                    <label for="test-volume" class="font-medium text-gray-700">Volume (uL)</label>
                    <input type="number" id="test-volume" name="test-volume" class="input-field p-2 border rounded-md" placeholder="Enter volume">
                </div>
                <div class="flex flex-col space-y-2">
                    <label for="test-source" class="font-medium text-gray-700">Source</label>
                    <input type="text" id="test-source" name="test-source" class="input-field p-2 border rounded-md" placeholder="e.g., source_well_A1">
                </div>
                <div class="flex flex-col space-y-2">
                    <label for="test-liquid-class" class="font-medium text-gray-700">Liquid Class</label>
                    <input type="text" id="test-liquid-class" name="test-liquid-class" class="input-field p-2 border rounded-md" placeholder="e.g., Water Free, 500ul">
                </div>
                <div class="flex justify-between items-center pt-4">
                    <button id="initialize-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Initialize</button>
                    <button id="pipette-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Pipette & Record</button>
                </div>
                <div id="test-output" class="mt-6 p-4 bg-gray-100 rounded-lg shadow-inner text-gray-800">
                    <p id="output-message" class="text-sm"></p>
                </div>
            </div>
        </div>
        <div class="flex justify-center mt-8">
            <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Save to JSON</button>
        </div>
    </div>

    <script>
        const form = document.getElementById('liquid-class-form');
        const inputFields = form.querySelectorAll('.input-field');
        const newLiquidClassNameInput = document.getElementById('new-liquid-class-name');
        const numFields = inputFields.length;
        const threshold = Math.ceil(numFields / 2);
        let timeoutId = null;

        const searchInput = document.getElementById('liquid-class-search');
        const searchResultsContainer = document.getElementById('search-results');
        let searchTimeoutId = null;

        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Correction curve table functionality
        const addRowBtn = document.getElementById('add-row-btn');
        const correctionTableBody = document.querySelector('#correction-table tbody');

        addRowBtn.addEventListener('click', () => {
            addRowToTable();
        });

        correctionTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-row-btn')) {
                e.target.closest('tr').remove();
            }
        });

        function addRowToTable(nominal = '', corrected = '') {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td class="py-2 px-4"><input type="number" class="w-1/2 p-1 border rounded" placeholder="Nominal" value="${nominal}"></td>
                <td class="py-2 px-4"><input type="number" class="w-1/2 p-1 border rounded" placeholder="Corrected" value="${corrected}"></td>
                <td class="py-2 px-4 text-center">
                    <button type="button" class="remove-row-btn text-red-500 hover:text-red-700 font-bold">Remove</button>
                </td>
            `;
            correctionTableBody.appendChild(newRow);
        }

        function populateCorrectionTable(curveData) {
            correctionTableBody.innerHTML = ''; // Clear existing rows
            for (const [nominal, corrected] of curveData) {
                addRowToTable(nominal, corrected);
            }
        }

        function parseAndSortCorrectionCurve(unpackedData) {
            if (!unpackedData) return [];
            
            const pairs = [];
            for (let i = 0; i < unpackedData.length; i += 2) {
                pairs.push([unpackedData[i], unpackedData[i + 1]]);
            }

            pairs.sort((a, b) => a[0] - b[0]);
            
            return pairs;
        }

        const paramMap = {
            'AsFlowRate': 'aspirate.FLOW_RATE',
            'AsMixFlowRate': 'aspirate.MIX_FLOW_RATE',
            'AsAirTransportVolume': 'aspirate.AIR_TRANSPORT_VOLUME',
            'AsBlowOutVolume': 'aspirate.BLOW_OUT_VOLUME',
            'AsSwapSpeed': 'aspirate.SWAP_SPEED',
            'AsSettlingTime': 'aspirate.SETTLING_TIME',
            'AsOverAspirateVolume': 'aspirate.OVER_ASPIRATE_VOLUME',
            'AsClotRetractHeight': 'aspirate.CLOT_RETRACT_HEIGHT',
            'DsFlowRate': 'dispense.FLOW_RATE',
            'DsMixFlowRate': 'dispense.MIX_FLOW_RATE',
            'DsAirTransportVolume': 'dispense.AIR_TRANSPORT_VOLUME',
            'DsBlowOutVolume': 'dispense.BLOW_OUT_VOLUME',
            'DsSwapSpeed': 'dispense.SWAP_SPEED',
            'DsSettlingTime': 'dispense.SETTLING_TIME',
            'DsStopFlowRate': 'dispense.STOP_FLOW_RATE',
            'DsStopBackVolume': 'dispense.STOP_BACK_VOLUME',
            'DispenseMode': 'dispense_mode',
            'TipType': 'tip_type',
            'CorrectionCurve': 'correction_curve'
        };

        // --- Event Listeners for Liquid Class Search ---
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeoutId);
            const query = searchInput.value;
            if (query.length > 2) {
                searchTimeoutId = setTimeout(() => fetchSearchResults(query), 300);
            } else {
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.add('hidden');
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', (event) => {
            if (!searchResultsContainer.contains(event.target) && event.target !== searchInput) {
                searchResultsContainer.classList.add('hidden');
            }
        });

        // --- Functions for Liquid Class Search ---
        async function fetchSearchResults(query) {
            try {
                const response = await fetch(`/search_liquid_classes?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const matches = await response.json();
                displaySearchResults(matches);
            } catch (error) {
                console.error('Search failed:', error);
                searchResultsContainer.innerHTML = `<p class="p-2 text-sm text-red-500">Failed to load results.</p>`;
                searchResultsContainer.classList.remove('hidden');
            }
        }

        function displaySearchResults(matches) {
            searchResultsContainer.innerHTML = '';
            if (matches.length > 0) {
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.className = 'p-2 cursor-pointer hover:bg-gray-200 transition-colors duration-150 ease-in-out';
                    item.textContent = match.name;
                    item.addEventListener('click', async () => {
                        const fullData = await fetchLiquidClass(match.name);
                        fillFormWithData(fullData);
                        searchInput.value = match.name;
                        searchResultsContainer.classList.add('hidden');
                    });
                    searchResultsContainer.appendChild(item);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.innerHTML = `<p class="p-2 text-sm text-gray-500">No matching liquid classes found.</p>`;
                searchResultsContainer.classList.remove('hidden');
            }
        }

        async function fetchLiquidClass(className) {
            try {
                const response = await fetch(`/get_liquid_class/${encodeURIComponent(className)}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to fetch liquid class details:', error);
                return {};
            }
        }
        
        function fillFormWithData(data) {
            inputFields.forEach(input => {
                const paramName = input.name;
                const dataPath = paramMap[paramName];
                let value;
                
                if (dataPath.includes('.')) {
                    const pathParts = dataPath.split('.');
                    let current = data;
                    for (const part of pathParts) {
                        current = current ? current[part] : undefined;
                    }
                    value = current;
                } else {
                    value = data[dataPath];
                }

                if (paramName === 'TipType') {
                    if (value && typeof value === 'object') {
                        input.value = `{"volume": ${value.volume}, "has_filter": ${value.has_filter}}`.replace(/"/g, "'");
                    } else {
                        input.value = '';
                    }
                } else if (paramName === 'DispenseMode') {
                     if (value !== undefined && value !== null) {
                        input.value = value.toString();
                    } else {
                        input.value = '';
                    }
                } else {
                    if (value !== undefined && value !== null) {
                        if (input.tagName === 'SELECT') {
                            input.value = value.toString();
                        } else {
                            input.value = value.toFixed(2);
                        }
                    } else {
                        input.value = '';
                    }
                }
                input.classList.remove('suggestion-text');
            });

            const correctionCurveData = data['correction_curve'];
            if (correctionCurveData && correctionCurveData.nominal && correctionCurveData.corrected) {
                const curvePairs = correctionCurveData.nominal.map((nominal, index) => [nominal, correctionCurveData.corrected[index]]);
                populateCorrectionTable(curvePairs);
            } else {
                populateCorrectionTable([]);
            }
            
            handleInput();
        }

        // --- Original Event Listeners for Parameter Prediction ---
        inputFields.forEach(input => {
            input.addEventListener('input', () => {
                if (input.classList.contains('suggestion-text')) {
                    input.classList.remove('suggestion-text');
                }
                clearTimeout(timeoutId);
                timeoutId = setTimeout(handleInput, 500);
            });

            input.addEventListener('keydown', (event) => {
                if (event.key === 'Tab' && input.classList.contains('suggestion-text')) {
                    input.classList.remove('suggestion-text');
                }
            });
        });

        async function handleInput() {
            const filledFields = Array.from(inputFields).filter(input => {
                return input.value.trim() !== '';
            });

            if (filledFields.length >= threshold) {
                const formData = {};
                filledFields.forEach(input => {
                    formData[input.name] = parseFloat(input.value);
                });
            }
        }
        
        // Get new test action elements
        const initializeBtn = document.getElementById('initialize-btn');
        const pipetteBtn = document.getElementById('pipette-btn');
        const testVolumeInput = document.getElementById('test-volume');
        const testSourceInput = document.getElementById('test-source');
        const testLiquidClassInput = document.getElementById('test-liquid-class');
        const outputMessage = document.getElementById('output-message');

        // Event listener for Initialize button
        initializeBtn.addEventListener('click', async () => {
            outputMessage.textContent = 'Initializing... Please wait.';
            try {
                const response = await fetch('/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                outputMessage.textContent = 'Initialization complete.';
            } catch (error) {
                console.error('Initialization failed:', error);
                outputMessage.textContent = `Initialization failed: ${error.message}`;
            }
        });

        // Event listener for Pipette & Record button
        pipetteBtn.addEventListener('click', async () => {
            const volume = parseFloat(testVolumeInput.value);
            const source = testSourceInput.value.trim();
            const liquidClass = testLiquidClassInput.value.trim();

            if (isNaN(volume) || !source || !liquidClass) {
                outputMessage.textContent = 'Please fill in all fields (Volume, Source, and Liquid Class) before pipetting.';
                return;
            }

            outputMessage.textContent = 'Pipetting and recording weight... Please wait.';
            try {
                const response = await fetch('/pipette_and_record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        volume: volume,
                        source: source,
                        liquid_class: liquidClass
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                outputMessage.textContent = `Pipette complete. Recorded weight: ${result.weight} grams.`;
            } catch (error) {
                console.error('Pipette & Record failed:', error);
                outputMessage.textContent = `Pipette & Record failed: ${error.message}`;
            }
        });

        // Save to JSON button logic
        const saveBtn = document.getElementById('save-btn');
        saveBtn.addEventListener('click', () => {
            const newLiquidClassName = newLiquidClassNameInput.value.trim();
            if (!newLiquidClassName) {
                alert("Please enter a name for the new liquid class before saving.");
                return;
            }

            const aspirateParams = {};
            const dispenseParams = {};
            
            inputFields.forEach(input => {
                if (input.id.startsWith('As') && input.value) {
                    aspirateParams[input.id.substring(2).toUpperCase()] = parseFloat(input.value);
                } else if (input.id.startsWith('Ds') && input.value) {
                    dispenseParams[input.id.substring(2).toUpperCase()] = parseFloat(input.value);
                }
            });

            // Handle special cases: TipType and DispenseMode
            const tipTypeSelect = document.getElementById('TipType');
            const dispenseModeSelect = document.getElementById('DispenseMode');
            const tipTypeData = tipTypeSelect.value ? JSON.parse(tipTypeSelect.value.replace(/'/g, '"')) : null;
            const dispenseModeData = dispenseModeSelect.options[dispenseModeSelect.selectedIndex].text;

            // Get correction curve data
            const correctionRows = correctionTableBody.querySelectorAll('tr');
            const nominalValues = [];
            const correctedValues = [];

            correctionRows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                if (inputs[0].value && inputs[1].value) {
                    nominalValues.push(parseFloat(inputs[0].value));
                    correctedValues.push(parseFloat(inputs[1].value));
                }
            });

            const liquidClassData = {
                "name": newLiquidClassName,
                "aspirate": aspirateParams,
                "dispense": dispenseParams,
                "tip_type": tipTypeData,
                "dispense_mode": dispenseModeData,
                "correction_curve": {
                    "nominal": nominalValues,
                    "corrected": correctedValues
                }
            };
            
            const jsonString = JSON.stringify([liquidClassData], null, 4);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${newLiquidClassName.replace(/[^a-zA-Z0-9]/g, '_')}_liquid_class.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>